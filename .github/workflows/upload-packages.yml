name: Upload package to Azure/incoming


permissions: {}


on:
  workflow_call:
    inputs:
      pkg-type:
        required: true
        type: string  # stable / nightly
      distros:
        required: false
        type: string
        default: '[
          "debian-stretch",
          "debian-buster",
          "debian-testing",
          "debian-sid",
          "ubuntu-xenial",
          "ubuntu-bionic",
          "debian-bullseye",
          "ubuntu-focal",
          "ubuntu-impish"
        ]'
    secrets:
      azure-sas-token:
        required: true


jobs:
  upload-packages:
    name: ${{ matrix.distro }}

    runs-on: ubuntu-latest

    if: github.repository_owner == 'alltilla'

    strategy:
      matrix:
        distro: ${{ fromJson(inputs.distros) }}
      fail-fast: false

    env:
      PKG_TYPE: ${{ inputs.pkg-type }}

    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v2
        with:
          name: package-${{ matrix.distro }}
          path: package

      - name: Calculate Azure path
        run: |
          if [[ ! "${PKG_TYPE}" =~ ^(stable|nightly)$ ]]; then
            echo "Unexpected input: pkg-type=${PKG_TYPE}"
            false
          fi

          AZURE_PATH="alltilla-test-incoming/${PKG_TYPE}/${{ github.run_id }}"

          echo "AZURE_PATH=${AZURE_PATH}" >> ${GITHUB_ENV}

      - name: Upload packages to Azure incoming
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az storage blob upload-batch \
              --sas-token '${{ secrets.azure-sas-token }}' \
              --account-name 'syslogngose' \
              --source 'package' \
              --destination '${{ env.AZURE_PATH }}'
